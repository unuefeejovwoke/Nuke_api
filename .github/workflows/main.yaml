name: Deploy Nuke_api

on:

  workflow_dispatch:
    # inputs:
    #   server-ip:
    #     type: string
    #     description: "Enter the public ip of the server"
    #     required: true

  push:
    branches:
      - "dev"


jobs:
  build-image:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: 4568910
          password: Daviddocker97

      - name: Build Docker image and save a previous version
        working-directory: app
        run: |
          docker build . -t 4568910/nuke_api:latest
          docker tag 4568910/nuke_api:latest:latest 4568910/nuke_api:latest:latest-2

          docker pull 4568910/nuke_api:latest:latest
          docker tag 4568910/nuke_api:latest:latest 4568910/nuke_api:latest:"v1.${GITHUB_RUN_NUMBER}"
          
          docker tag 4568910/nuke_api:latest:latest-2 4568910/nuke_api:latest:latest

      - name: Push Docker image
        run: |
          docker push 4568910/nuke_api:latest:"v1.${GITHUB_RUN_NUMBER}"
          docker push 4568910/nuke_api:latest:latest



  configure-server:
    runs-on: ubuntu-latest
    needs: [ build-image ]

    defaults:
      run:
        working-directory: ansible
      
    steps:
      - uses: actions/checkout@v4

      - name: Setup ssh
        shell: bash 
        run: |
          service ssh status
          eval `ssh-agent -s`
          mkdir -p /home/runner/.ssh/
          touch /home/runner/.ssh/id_rsa
          echo -e "${{secrets.RUNNER_PRIV_KEY}}" > /home/runner/.ssh/id_rsa
          chmod 700 /home/runner/.ssh/id_rsa
          # ssh-keyscan -t rsa,dsa,ecdsa,ed25519 ${{ inputs.server-ip }} >> /home/runner/.ssh/known_hosts
          ssh-keyscan -t rsa,dsa,ecdsa,ed25519 34.214.121.37 >> /home/runner/.ssh/known_hosts

      - name: Run ansible script
        shell: bash 
        run: |
          ansible-playbook -i /home/runner/work/Nuke_api/Nuke_api/ansible/host-inventory \
          --private-key /home/runner/.ssh/id_rsa -u ubuntu server.yaml -vvv
  